#include "dsk6713_aic23.h"

Uint32 input_left_sample();
void output_left_sample(int out_data);
void comm_intr();

#define 	N 			192
#define 	CONTRASTE 	8
#define 	TIME_5sec 	2500 	// 5*Fe/N = 2500
#define 	TIME_10ms 	960 	// 0.010 * Fe = 960
#define 	TIME_1sec 	96000 	// 1 * Fe = 96000

short XnBufferExcel[N] = 		// Table Sinus de fréquence 22 KHz
{0,32488,8481,-30274,-16384,25997,23170,-19948,-28378,12540,31651,-4277,-32768,-4277,31651,12540,
-28378,-19948,23170,25997,-16384,-30274,8481,32488,0,-32488,-8481,30274,16384,-25997,-23170,19948,
28378,-12540,-31651,4277,32767,4277,-31651,-12540,28378,19948,-23170,-25997,16384,30274,-8481,-32488,
0,32488,8481,-30274,-16384,25997,23170,-19948,-28378,12540,31651,-4277,-32768,-4277,31651,12540,
-28378,-19948,23170,25997,-16384,-30274,8481,32488,0,-32488,-8481,30274,16384,-25997,-23170,19948,
28378,-12540,-31651,4277,32767,4277,-31651,-12540,28378,19948,-23170,-25997,16384,30274,-8481,-32488,
0,32488,8481,-30274,-16384,25997,23170,-19948,-28378,12540,31651,-4277,-32768,-4277,31651,12540,
-28378,-19948,23170,25997,-16384,-30274,8481,32488,0,-32488,-8481,30274,16384,-25997,-23170,19948,
28378,-12540,-31651,4277,32767,4277,-31651,-12540,28378,19948,-23170,-25997,16384,30274,-8481,-32488,
0,32488,8481,-30274,-16384,25997,23170,-19948,-28378,12540,31651,-4277,-32768,-4277,31651,12540,
-28378,-19948,23170,25997,-16384,-30274,8481,32488,0,-32488,-8481,30274,16384,-25997,-23170,19948,
28378,-12540,-31651,4277,32767,4277,-31651,-12540,28378,19948,-23170,-25997,16384,30274,-8481,-32488 };

short Coeff[8] = {23085, 21066, 19024, 16962, 14882, 12785, 10676, 8554};

short TabSinus1Hz[N] =
{0,1072,2143,3212,4277,5338,6393,7441,8481,9512,10533,11543,12540,13524,14493,15447,
16384,17304,18205,19087,19948,20788,21605,22400,23170,23916,24636,25330,25997,26635,27246,27827,
28378,28899,29389,29847,30274,30668,31029,31357,31651,31912,32138,32330,32488,32610,32698,32750,
32767,32750,32698,32610,32488,32330,32138,31912,31651,31357,31029,30668,30274,29847,29389,28899,
28378,27827,27246,26635,25997,25330,24636,23916,23170,22400,21605,20788,19948,19087,18205,17304,
16384,15447,14493,13524,12540,11543,10533,9512,8481,7441,6393,5338,4277,3212,2143,1072,
0,-1072,-2143,-3212,-4277,-5338,-6393,-7441,-8481,-9512,-10533,-11543,-12540,-13524,-14493,-15447,
-16384,-17304,-18205,-19087,-19948,-20788,-21605,-22400,-23170,-23916,-24636,-25330,-25997,-26635,-27246,-27827,
-28378,-28899,-29389,-29847,-30274,-30668,-31029,-31357,-31651,-31912,-32138,-32330,-32488,-32610,-32698,-32750,
-32768,-32750,-32698,-32610,-32488,-32330,-32138,-31912,-31651,-31357,-31029,-30668,-30274,-29847,-29389,-28899,
-28378,-27827,-27246,-26635,-25997,-25330,-24636,-23916,-23170,-22400,-21605,-20788,-19948,-19087,-18205,-17304,
-16384,-15447,-14493,-13524,-12540,-11543,-10533,-9512,-8481,-7441,-6393,-5338,-4277,-3212,-2143,-1072 };

Uint32 fs = DSK6713_AIC23_FREQ_96KHZ;
short Xn, i = 0, f;
short Qn[8], Qn_1[8], Qn_2[8];
Uint32 Module[8];
int tmp;
short tmp1, New_Modules = 0;
short XnBuffer[N];

interrupt void c_int11()
{
	Xn = input_left_sample();
	XnBuffer[i] = Xn;
//	Xn = XnBufferExcel[i];

	for(f = 0; f < 8; f++){
		tmp = (int) (Xn << 8) + (int) (Coeff[f] * Qn_1[f]) - (int) (Qn_2[f] << 15);
		Qn[f] = (short) (tmp >> 15);

		Qn_2[f] = Qn_1[f];
		Qn_1[f] = Qn[f];
	}

	i = (i + 1) % N;

	if(i == 0){
		for(f = 0; f < 8; f++){
			tmp1 = (short) ((Qn_1[f] * Coeff[f]) >> 15);	// (Q8(16) * Q15(16)) >> 15 = Q8(16)
			tmp = (int) (tmp1 * Qn_2[f]);
			Module[f] = (Uint32) (Qn_1[f]*Qn_1[f] + Qn_2[f]*Qn_2[f] - tmp);
		}
		New_Modules = 1;
	}

	output_left_sample(Xn);
	return;
}

main()
{
	i = 0;	New_Modules = 0;
	for(f = 0; f < 8; f++){
		Qn[f] = 0;		Qn_1[f] = 0;		Qn_2[f] = 0;
	}
	comm_intr();
	while(1);
}
